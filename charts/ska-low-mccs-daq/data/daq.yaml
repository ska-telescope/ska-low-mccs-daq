{{- $defaults := dict
  "receiver_interface" "eth0"
  "receiver_ip" ""
  "receiver_port" 4660
  "grpc_port" 50051
  "logging_level_default" 3
}}
name: daq-receiver-{{.Release.Name}}
function: ska-low-mccs-daq-daqreceiver
domain: ska-low-mccs-daq
instances:
{{- range $id, $spec := .Values.receivers }}
  - {{printf "daq-receiver-%03d-tango" (int $id)}}
{{- end }}
command: "MccsDaqReceiver"
server:
  name: "MccsDaqReceiver"
  instances:
{{- range $id, $spec := .Values.receivers }}
{{- $defaulted := merge $spec $defaults}}
{{- $slug := (printf "daq-receiver-%03d" (int $id))}}
    - name: {{$slug}}-tango
      classes:
      - name: "MccsDaqReceiver"
        devices:
        - name: {{printf "low-mccs/daqreceiver/%03d" (int $id)}}
          properties:
          - name: "DaqId"
            values:
            - {{$id | toString | quote}}
          - name: "ReceiverInterface"
            values:
            - {{$defaulted.receiver_interface | quote}}
          - name: "ReceiverIp"
            values:
            - {{$defaulted.receiver_ip | quote}}
          - name: "ReceiverPort"
            values:
            - {{$defaulted.receiver_port | toString | quote}}
          - name: "Host"
            values:
            - {{coalesce $spec.grpc_ip (printf "%s-grpc-svc" $slug) | quote }}
          - name: "Port"
            values:
            - {{$defaulted.grpc_port | toString | quote}}
          - name: "ConsumersToStart"
            values:
            - "DaqModes.INTEGRATED_CHANNEL_DATA"
          - name: "LoggingLevelDefault"
            values: 
            - {{$defaulted.logging_level_default | toString | quote}}
    {{- end }} # devices
depends_on:
  - device: sys/database/2
image:
{{- with .Values.image}}
  registry: "{{.registry}}"
  image: "{{.name}}"
  tag: "{{.tag}}"
  pullPolicy: "{{.pullPolicy}}"
{{- end}}
livenessProbe:
{{ toYaml .Values.livenessProbe | indent 2 }}
readinessProbe:
{{ toYaml .Values.readinessProbe | indent 2 }}
securityContext:
  capabilities:
    add: ["NET_RAW", "IPC_LOCK", "SYS_NICE", "SYS_ADMIN", "KILL", "SYS_TIME"]
